%% Copula Fit% Copyright 2014 The MathWorks, Inc.

%% Load Returnsload('Equity_MidCap.mat')Prices  = table2array(Prices);Returns = tick2ret(Prices);nInv    = size(Returns,2);%% Fit a DistributionDistributionObject = cell(nInv,1);for i = 1:nInv    DistributionObject{i} = fitdist(Returns(:,i),'Kernel');end%% Estimate Parameters of a Copula FitU = zeros(size(Returns));ticfor i = 1:nInv    U(:,i) = DistributionObject{i}.cdf(Returns(:,i)); % transform margin to uniformendtoc[R, DoF] = copulafit('t', U, 'Method', 'ApproximateML'); % fit the copula%% Generate random numbers with the estimated correlation structurenTrials = 2000;                                   % # of independent random trialshorizon = 22;                                     % VaR forecast horizonZ = zeros(horizon, nTrials, nInv);            % standardized residuals arrayU = copularnd('t', R, DoF, horizon * nTrials);    % t copula simulationfor j = 1:nInv    Z(:,:,j) = reshape(DistributionObject{j}.icdf(U(:,j)), horizon, nTrials);end